<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingredient List Consolidator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState } = React;

        function IngredientConsolidator() {
            const [lists, setLists] = useState(['', '', '']);
            const [consolidated, setConsolidated] = useState([]);
            const [copyStatus, setCopyStatus] = useState('');
            const [summary, setSummary] = useState(null);

            function splitCommaDelimited(text) {
                // Split by commas and create individual lines
                return text.split(',').map(item => item.trim()).filter(item => item.length > 0).join('\n');
            }

            function parseQuantity(text) {
                // Handle ranges - always take upper limit
                const rangeMatch = text.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)/);
                if (rangeMatch) {
                    const upperLimit = parseFloat(rangeMatch[2]);
                    text = text.replace(rangeMatch[0], upperLimit.toString());
                }

                const patterns = [
                    /(\d+\.?\d*)\s*(lbs?|pounds?)/i,
                    /(\d+\.?\d*)\s*(oz|ounces?)/i,
                    /(\d+\.?\d*)\s*(gallons?)/i,
                    /(\d+\.?\d*)\s*(cups?)/i,
                    /(\d+\.?\d*)\s*(packs?|packets?)/i,
                    /(\d+\.?\d*)\s*(jars?)/i,
                    /(\d+\.?\d*)\s*(bottles?)/i,
                    /(\d+\.?\d*)\s*(blocks?)/i,
                    /(\d+\.?\d*)\s*(boxes?)/i,
                    /(\d+\.?\d*)\s*(bunches?)/i,
                    /(\d+\.?\d*)\s*(cartons?)/i,
                    /(\d+\.?\d*)\s*(stalks?)/i,
                    /(\d+\.?\d*)\s*(cloves?)/i,
                    /(\d+\.?\d*)\s*(count)/i,
                    /(\d+\.?\d*)\s*(cans?)/i,
                    /(\d+\.?\d*)\s*(tins?)/i,
                    /(\d+\.?\d*)\s*(bags?)/i,
                    /(\d+\.?\d*)\s*(sticks?)/i,
                ];

                for (let pattern of patterns) {
                    const match = text.match(pattern);
                    if (match) {
                        return { quantity: parseFloat(match[1]), unit: match[2].toLowerCase() };
                    }
                }

                const numMatch = text.match(/(\d+\.?\d*)/);
                if (numMatch) {
                    return { quantity: parseFloat(numMatch[1]), unit: 'count' };
                }

                return { quantity: 1, unit: 'count' };
            }

            function normalizeUnit(unit) {
                const unitMap = {
                    'lb': 'lbs', 'pound': 'lbs', 'pounds': 'lbs',
                    'oz': 'oz', 'ounce': 'oz', 'ounces': 'oz',
                    'gallon': 'gallons', 'cup': 'cups',
                    'pack': 'packs', 'packet': 'packs', 'packets': 'packs',
                    'jar': 'jars', 'bottle': 'bottles', 'block': 'blocks',
                    'box': 'boxes', 'bunch': 'bunches', 'carton': 'cartons',
                    'stalk': 'stalks', 'clove': 'cloves',
                    'can': 'cans', 'cans': 'cans',
                    'tin': 'tins', 'tins': 'tins',
                    'bag': 'bags', 'bags': 'bags',
                    'stick': 'sticks', 'sticks': 'sticks',
                };
                return unitMap[unit] || unit;
            }

            function normalizeIngredientName(name) {
                let normalized = name.toLowerCase().trim();
                
                // Remove dashes
                normalized = normalized.replace(/-/g, ' ');
                
                const isPepper = normalized.includes('pepper') && !normalized.includes('crushed') && !normalized.includes('flakes');
                
                const removeWords = [
                    'twin pack', 'costco', 'restaurant depot', 'trader joe',
                    'organic', 'extra virgin', 'virgin', 'unsalted', 'salted',
                    'fresh', 'frozen', 'canned',
                    'shredded', 'diced', 'chopped', 'sliced', 'whole', 'peeled',
                    'flat leaf', 'baby', 'purÃ©e', 'puree',
                    '\\(.*?\\)'
                ];
                
                if (!isPepper) {
                    removeWords.push('red', 'green', 'yellow', 'white', 'black', 'purple');
                }
                
                removeWords.forEach(word => {
                    const regex = new RegExp('\\b' + word + '\\b', 'gi');
                    normalized = normalized.replace(regex, '');
                });
                
                normalized = normalized.replace(/\s+/g, ' ').trim();
                
                // Handle "garlic cloves" -> "garlic"
                normalized = normalized.replace(/\bgarlic\s+clove[s]?\b/gi, 'garlic');
                
                const pluralMap = {
                    'tomatoes': 'tomato', 'potatoes': 'potato', 'onions': 'onion',
                    'carrots': 'carrot', 'peppers': 'pepper',
                    'chilies': 'chili', 'chillies': 'chili',
                    'lemons': 'lemon', 'limes': 'lime',
                    'leaves': 'leaf', 'bunches': 'bunch',
                };
                
                for (let [plural, singular] of Object.entries(pluralMap)) {
                    if (normalized.endsWith(plural)) {
                        normalized = normalized.replace(new RegExp(plural + '$'), singular);
                        break;
                    }
                }
                
                return normalized;
            }

            function parseIngredientLine(line) {
                line = line.replace(/[\u2060\u200B\u200C\u200D\uFEFF]/g, '');
                line = line.replace(/^[â€¢\-\*\s]+/, '').trim();
                if (!line) return null;

                // Check if this is a "pantry" item - FIXED: Check before parsing quantity
                if (line.toLowerCase().includes('pantry')) {
                    // Extract just the ingredient name without "pantry"
                    let name = line.replace(/\bpantry\b/gi, '').trim();
                    // Remove trailing dashes, hyphens, and extra spaces
                    name = name.replace(/[-â€“â€”]+\s*$/g, '').trim();
                    name = name.replace(/\s*[-â€“â€”]+$/g, '').trim();
                    const cleanName = normalizeIngredientName(name || line);
                    return {
                        name: cleanName,
                        quantity: null, // No quantity for pantry items
                        unit: 'pantry',
                        original: line,
                        isPantry: true
                    };
                }

                const quantityInfo = parseQuantity(line);
                
                let ingredientName = line;
                // Remove the quantity and unit from the name
                const quantityPattern = /(\d+\.?\d*)(\s*-\s*\d+\.?\d*)?\s*[\w]+/;
                const match = line.match(quantityPattern);
                if (match) {
                    ingredientName = line.replace(match[0], '').trim();
                }
                
                ingredientName = ingredientName.replace(/^[\s,\-]+/, '').trim();
                
                return {
                    name: normalizeIngredientName(ingredientName),
                    quantity: quantityInfo.quantity,
                    unit: normalizeUnit(quantityInfo.unit),
                    original: line,
                    isPantry: false
                };
            }

            function consolidateIngredients() {
                const allIngredients = [];
                const listStats = [];

                lists.forEach((list, index) => {
                    if (!list.trim()) return;
                    
                    const lines = list.split('\n');
                    let itemCount = 0;
                    
                    lines.forEach(line => {
                        const parsed = parseIngredientLine(line);
                        if (parsed) {
                            allIngredients.push(parsed);
                            itemCount++;
                        }
                    });
                    
                    if (itemCount > 0) {
                        listStats.push({
                            listNumber: index + 1,
                            itemCount: itemCount
                        });
                    }
                });

                const grouped = {};
                allIngredients.forEach(item => {
                    const key = item.name;
                    if (!grouped[key]) {
                        grouped[key] = {
                            name: item.name,
                            items: [],
                            isPantry: item.isPantry
                        };
                    }
                    // If any instance is pantry, mark the whole group as pantry
                    if (item.isPantry) {
                        grouped[key].isPantry = true;
                    }
                    grouped[key].items.push(item);
                });

                const result = Object.values(grouped).map(group => {
                    // FIXED: Handle pantry items specially - consolidate all to single "pantry"
                    if (group.isPantry) {
                        return {
                            name: group.name,
                            count: 'pantry',
                            wasCombined: group.items.length > 1,
                            isPantry: true
                        };
                    }
                    
                    const unitGroups = {};
                    group.items.forEach(item => {
                        if (!item.isPantry) { // Only count non-pantry items
                            if (!unitGroups[item.unit]) {
                                unitGroups[item.unit] = 0;
                            }
                            unitGroups[item.unit] += item.quantity;
                        }
                    });

                    const countParts = Object.entries(unitGroups).map(([unit, qty]) => {
                        if (unit === 'count') {
                            return qty.toString();
                        }
                        return `${qty} ${unit}`;
                    });

                    return {
                        name: group.name,
                        count: countParts.join(' + '),
                        wasCombined: group.items.length > 1,
                        isPantry: false
                    };
                });

                // FIXED: Sort pantry items to the bottom
                result.sort((a, b) => {
                    // If one is pantry and the other isn't, pantry goes to bottom
                    if (a.isPantry && !b.isPantry) return 1;
                    if (!a.isPantry && b.isPantry) return -1;
                    // Otherwise sort alphabetically
                    return a.name.localeCompare(b.name);
                });

                const totalInputItems = allIngredients.length;
                const consolidatedCount = result.length;
                const itemsSaved = totalInputItems - consolidatedCount;

                setSummary({
                    listStats,
                    totalInputItems,
                    consolidatedCount,
                    itemsSaved
                });

                setConsolidated(result);
            }

            function copyToGoogleSheets() {
                const sheetData = consolidated.map(item => `${item.name}\t${item.count}`).join('\n');
                const header = 'Items\tUnits\n';
                const fullData = header + sheetData;
                
                navigator.clipboard.writeText(fullData).then(() => {
                    setCopyStatus('âœ“ Copied! Paste into Google Sheets');
                    setTimeout(() => setCopyStatus(''), 3000);
                }).catch(() => {
                    setCopyStatus('âŒ Failed to copy');
                    setTimeout(() => setCopyStatus(''), 3000);
                });
            }

            // FIXED: Add function to add new lists
            function addNewList() {
                setLists([...lists, '']);
            }

            // FIXED: Add function to remove a list
            function removeList(index) {
                if (lists.length > 1) {
                    const newLists = lists.filter((_, i) => i !== index);
                    setLists(newLists);
                }
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">
                    <div className="container mx-auto px-4 py-8 max-w-6xl">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold text-gray-800 mb-2">ðŸ›’ Ingredient List Consolidator</h1>
                            <p className="text-gray-600 mb-6">Paste your ingredient lists and consolidate them</p>

                            <div className="space-y-4 mb-6">
                                {lists.map((list, index) => (
                                    <div key={index}>
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="font-semibold text-gray-700">List {index + 1}</label>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => {
                                                        const newLists = [...lists];
                                                        newLists[index] = splitCommaDelimited(list);
                                                        setLists(newLists);
                                                    }}
                                                    className="text-sm px-3 py-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded transition-colors"
                                                >
                                                    Split by Commas
                                                </button>
                                                {lists.length > 1 && (
                                                    <button
                                                        onClick={() => removeList(index)}
                                                        className="text-sm px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded transition-colors"
                                                    >
                                                        Remove
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                        <textarea
                                            value={list}
                                            onChange={(e) => {
                                                const newLists = [...lists];
                                                newLists[index] = e.target.value;
                                                setLists(newLists);
                                            }}
                                            placeholder="Paste ingredients here (comma-separated or line-separated)..."
                                            className="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        />
                                    </div>
                                ))}
                            </div>

                            <div className="flex gap-3 justify-center">
                                <button
                                    onClick={addNewList}
                                    className="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors"
                                >
                                    + Add Another List
                                </button>
                                <button
                                    onClick={consolidateIngredients}
                                    className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors"
                                >
                                    Consolidate Lists
                                </button>
                            </div>
                        </div>

                        {summary && (
                            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl shadow-lg p-6 mb-6 border border-blue-200">
                                <h2 className="text-xl font-bold text-gray-800 mb-4">ðŸ“Š Summary Statistics</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-white rounded-lg p-4 shadow-sm">
                                        <h3 className="font-semibold text-gray-700 mb-3">Input Lists</h3>
                                        <div className="space-y-2">
                                            {summary.listStats.map((stat, index) => (
                                                <div key={index} className="flex justify-between items-center">
                                                    <span className="text-gray-600">List {stat.listNumber}:</span>
                                                    <span className="font-semibold text-blue-600">{stat.itemCount} items</span>
                                                </div>
                                            ))}
                                            <div className="border-t pt-2 mt-2 flex justify-between items-center">
                                                <span className="font-semibold text-gray-700">Total Input:</span>
                                                <span className="font-bold text-lg text-blue-700">{summary.totalInputItems} items</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-lg p-4 shadow-sm">
                                        <h3 className="font-semibold text-gray-700 mb-3">Consolidation Result</h3>
                                        <div className="space-y-2">
                                            <div className="flex justify-between items-center">
                                                <span className="text-gray-600">Final List:</span>
                                                <span className="font-semibold text-green-600">{summary.consolidatedCount} items</span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <span className="text-gray-600">Items Combined:</span>
                                                <span className="font-semibold text-orange-600">{summary.itemsSaved} items</span>
                                            </div>
                                            <div className="border-t pt-2 mt-2">
                                                <div className="bg-green-100 rounded p-2 text-center">
                                                    <span className="text-green-800 font-semibold">
                                                        âœ“ Reduced by {summary.totalInputItems > 0 ? Math.round((summary.itemsSaved / summary.totalInputItems) * 100) : 0}%
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {consolidated.length > 0 && (
                            <div className="bg-white rounded-xl shadow-lg p-8">
                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-800">Shopping List</h2>
                                        <p className="text-sm text-gray-600 mt-1">
                                            <span className="inline-block w-4 h-4 bg-green-100 border border-green-300 mr-1"></span>
                                            Consolidated items
                                            <span className="inline-block w-4 h-4 bg-amber-50 border border-amber-300 ml-3 mr-1"></span>
                                            Pantry items
                                        </p>
                                    </div>
                                    <div className="flex flex-col items-end gap-2">
                                        <button
                                            onClick={copyToGoogleSheets}
                                            className="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors flex items-center gap-2"
                                        >
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                            </svg>
                                            Copy to Google Sheets
                                        </button>
                                        {copyStatus && (
                                            <span className={`text-sm font-medium ${copyStatus.includes('âœ“') ? 'text-green-600' : 'text-red-600'}`}>
                                                {copyStatus}
                                            </span>
                                        )}
                                    </div>
                                </div>
                                
                                <table className="w-full border-collapse">
                                    <thead>
                                        <tr className="bg-gray-100">
                                            <th className="border border-gray-300 px-4 py-3 text-left font-semibold">Items</th>
                                            <th className="border border-gray-300 px-4 py-3 text-left font-semibold">Units</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {consolidated.map((item, index) => {
                                            let rowClass = "hover:bg-gray-50";
                                            if (item.isPantry) {
                                                rowClass = "bg-amber-50 border-l-4 border-l-amber-500";
                                            } else if (item.wasCombined) {
                                                rowClass = "bg-green-100 border-l-4 border-l-green-500";
                                            }
                                            return (
                                                <tr key={index} className={rowClass}>
                                                    <td className="border border-gray-300 px-4 py-2">{item.name}</td>
                                                    <td className="border border-gray-300 px-4 py-2">{item.count}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<IngredientConsolidator />, document.getElementById('root'));
    </script>
</body>
</html>
